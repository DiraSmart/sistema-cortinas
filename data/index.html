<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirasmart - RF Controller</title>
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <meta name="theme-color" content="#1A2634">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <img src="img/dirasmart-logo.png" alt="Dirasmart" class="header-logo">
                <h1>RF Controller</h1>
            </div>
            <div class="status-bar">
                <span id="wifi-status" class="status-indicator">WiFi: --</span>
                <span id="rf-status" class="status-indicator">RF: --</span>
                <span id="time-display">--:--</span>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="devices">Dispositivos</button>
            <button class="tab-btn" data-tab="capture">Capturar</button>
            <button class="tab-btn" data-tab="identify">Identificar</button>
            <button class="tab-btn" data-tab="config">Configuración</button>
            <button class="tab-btn" data-tab="backup">Backup</button>
        </nav>

        <!-- Tab Content -->
        <main class="content">
            <!-- Dispositivos Tab -->
            <section id="devices-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Mis Dispositivos</h2>
                    <button class="btn btn-primary" onclick="showAddDeviceModal()">+ Agregar</button>
                </div>

                <div class="filter-bar">
                    <select id="filter-type" onchange="filterDevices()">
                        <option value="">Todos los tipos</option>
                        <option value="1">Cortinas</option>
                        <option value="2">Interruptores</option>
                        <option value="3">Botones</option>
                        <option value="4">Portones</option>
                        <option value="5">Luces</option>
                        <option value="6">Ventiladores</option>
                        <option value="7">Dimmers</option>
                        <option value="99">Otros</option>
                    </select>
                    <select id="filter-room" onchange="filterDevices()">
                        <option value="">Todas las habitaciones</option>
                    </select>
                </div>

                <div id="devices-list" class="devices-grid">
                    <!-- Dispositivos se cargan dinámicamente -->
                </div>
            </section>

            <!-- Capturar Tab -->
            <section id="capture-tab" class="tab-content">
                <div class="capture-panel">
                    <h2>Capturar Señal RF</h2>

                    <!-- Paso 1: Seleccionar dispositivo y función -->
                    <div class="capture-target">
                        <h3>1. Seleccionar destino (opcional)</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Dispositivo</label>
                                <select id="capture-device" onchange="updateCaptureSignalOptions()">
                                    <option value="">-- Seleccionar --</option>
                                    <!-- Se llena dinámicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Función</label>
                                <select id="capture-signal-slot">
                                    <option value="">-- Primero selecciona dispositivo --</option>
                                </select>
                            </div>
                        </div>
                        <p class="help-text">Opcional para capturar. Requerido solo para guardar la señal. Para A-OK puedes capturar primero y usar "Detectar A-OK".</p>
                    </div>

                    <!-- Paso 2: Configuración RF -->
                    <div class="capture-settings">
                        <h3>2. Configuración RF</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Frecuencia (MHz)</label>
                                <div class="frequency-selector">
                                    <select id="capture-frequency">
                                        <option value="433.92">433.92 MHz (Europa/Latam)</option>
                                        <option value="315.00">315.00 MHz (USA/Asia)</option>
                                        <option value="868.00">868.00 MHz (Europa)</option>
                                        <option value="300.00">300.00 MHz</option>
                                        <option value="303.87">303.87 MHz</option>
                                        <option value="310.00">310.00 MHz</option>
                                        <option value="390.00">390.00 MHz</option>
                                        <option value="418.00">418.00 MHz</option>
                                        <option value="915.00">915.00 MHz (USA)</option>
                                        <option value="custom">Personalizada...</option>
                                    </select>
                                    <input type="number" id="custom-frequency" step="0.01" placeholder="MHz" style="display:none;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Modulación</label>
                                <select id="capture-modulation">
                                    <option value="2">ASK/OOK (más común)</option>
                                    <option value="0">2-FSK</option>
                                    <option value="1">GFSK</option>
                                    <option value="3">4-FSK</option>
                                    <option value="4">MSK</option>
                                </select>
                            </div>
                        </div>

                        </div>
                    </div>

                    <!-- Paso 3: Capturar -->
                    <div class="capture-action-section">
                        <h3>3. Capturar</h3>
                        <div class="capture-controls">
                            <button id="btn-start-capture" class="btn btn-large btn-success" onclick="startCapture()">
                                Iniciar Captura
                            </button>
                            <button id="btn-stop-capture" class="btn btn-large btn-danger" onclick="stopCapture()" style="display:none;">
                                Detener
                            </button>
                        </div>

                        <div id="capture-status" class="capture-status">
                            <div class="status-icon"></div>
                            <p>Presiona el botón de tu control remoto</p>
                        </div>
                    </div>

                    <!-- Resultado -->
                    <div id="capture-result" class="capture-result" style="display:none;">
                        <h3>Señal Capturada</h3>
                        <div class="signal-info">
                            <p><strong>Longitud:</strong> <span id="signal-length">--</span> bytes</p>
                            <p><strong>Frecuencia:</strong> <span id="signal-frequency">--</span> MHz</p>
                            <p><strong>Modulación:</strong> <span id="signal-modulation">--</span></p>
                            <p><strong>Protocolo detectado:</strong> <span id="signal-protocol">--</span></p>
                        </div>
                        <div class="form-group">
                            <label>Repeticiones de envío (1-20)</label>
                            <input type="number" id="signal-repeat-count" value="5" min="1" max="20" step="1">
                            <small class="help-text">Cantidad de veces que se repite la señal al transmitir</small>
                        </div>
                        <div class="signal-analysis">
                            <h4>Análisis de señal</h4>
                            <pre id="signal-analysis"></pre>
                        </div>
                        <div class="signal-raw">
                            <h4>Datos RAW (pulsos en µs)</h4>
                            <div class="raw-data-container">
                                <pre id="signal-raw-data"></pre>
                            </div>
                            <small class="help-text">Formato: duración_pulso (µs) - alternando HIGH/LOW</small>
                        </div>
                        <div class="capture-actions">
                            <button class="btn btn-primary" onclick="testCapturedSignal()">Probar Señal</button>
                            <button class="btn btn-success" onclick="saveCurrentCapture()">Guardar</button>
                            <button class="btn btn-warning" onclick="decodeAsAOK()">Detectar A-OK</button>
                            <button class="btn btn-secondary" onclick="clearCapture()">Nueva Captura</button>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Identificar Tab -->
            <section id="identify-tab" class="tab-content">
                <div class="identify-panel">
                    <h2>Identificar Control Remoto</h2>
                    <p class="help-text">
                        El sistema escaneará automáticamente <strong>todas las frecuencias y modulaciones comunes</strong>
                        para detectar tu control remoto y mostrarte la configuración correcta.
                    </p>

                    <div class="frequency-list">
                        <h4>Frecuencias a escanear:</h4>
                        <p>300, 303.87, 310, 315, 390, 418, 433, 433.42, 433.92, 434, 868, 915 MHz</p>
                    </div>

                    <div class="identify-controls">
                        <button id="btn-identify" class="btn btn-large btn-primary" onclick="identifySignal()">
                            Iniciar Identificación
                        </button>
                        <p class="help-text" style="margin-top: 15px;">
                            Presiona el botón de tu control remoto <strong>repetidamente</strong> durante el escaneo.
                        </p>
                    </div>

                    <div id="identify-status" class="identify-status" style="display:none;">
                        <div class="spinner"></div>
                        <p id="identify-status-text">Escaneando frecuencias...</p>
                        <p id="identify-progress" class="help-text">0 / 12 frecuencias</p>
                    </div>

                    <div id="identify-result" class="identify-result" style="display:none;">
                        <h4>Resultado de Identificación</h4>
                        <div class="identify-info">
                            <div class="info-row">
                                <span class="info-label">Frecuencia detectada:</span>
                                <span id="identify-freq" class="info-value">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Modulación:</span>
                                <span id="identify-mod" class="info-value">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Protocolo:</span>
                                <span id="identify-protocol" class="info-value">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Intensidad (RSSI):</span>
                                <span id="identify-rssi" class="info-value">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Longitud señal:</span>
                                <span id="identify-length" class="info-value">--</span>
                            </div>
                        </div>

                        <div class="identify-analysis">
                            <h5>Análisis Detallado</h5>
                            <pre id="identify-analysis-text"></pre>
                        </div>

                        <div class="identify-actions">
                            <button class="btn btn-success" onclick="useIdentifiedSettings()">
                                Usar estos ajustes para capturar
                            </button>
                            <button class="btn btn-secondary" onclick="clearIdentifyResult()">
                                Nueva identificación
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Configuración Tab -->
            <section id="config-tab" class="tab-content">
                <div class="config-sections">
                    <!-- WiFi -->
                    <div class="config-section">
                        <h3>Conexión WiFi</h3>
                        <div class="form-group">
                            <label>Red WiFi</label>
                            <div class="wifi-select">
                                <select id="wifi-ssid" onchange="toggleManualSSID()">
                                    <option value="">Seleccionar red...</option>
                                    <option value="__manual__">Ingresar manualmente...</option>
                                </select>
                                <button class="btn btn-small" onclick="scanWiFi()">Buscar</button>
                            </div>
                        </div>
                        <div class="form-group" id="manual-ssid-group" style="display:none;">
                            <label>Nombre de red (SSID)</label>
                            <input type="text" id="wifi-ssid-manual" placeholder="Nombre de la red WiFi">
                        </div>
                        <div class="form-group">
                            <label>Contraseña</label>
                            <input type="password" id="wifi-password" placeholder="Contraseña WiFi">
                        </div>
                        <button class="btn btn-primary" onclick="connectWiFi()">Conectar</button>
                    </div>

                    <!-- MQTT -->
                    <div class="config-section">
                        <h3>MQTT (Home Assistant)</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="mqtt-enabled"> Habilitar MQTT
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Servidor MQTT</label>
                            <input type="text" id="mqtt-server" placeholder="192.168.1.100">
                        </div>
                        <div class="form-group">
                            <label>Puerto</label>
                            <input type="number" id="mqtt-port" value="1883">
                        </div>
                        <div class="form-group">
                            <label>Usuario (opcional)</label>
                            <input type="text" id="mqtt-user" placeholder="Usuario">
                        </div>
                        <div class="form-group">
                            <label>Contraseña (opcional)</label>
                            <input type="password" id="mqtt-password" placeholder="Contraseña">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="mqtt-discovery" checked> Auto-discovery Home Assistant
                            </label>
                        </div>
                        <button class="btn btn-secondary" onclick="mqttRediscover()">Redescubrir dispositivos</button>
                    </div>

                    <!-- Zona Horaria -->
                    <div class="config-section">
                        <h3>Fecha y Hora</h3>
                        <div class="form-group">
                            <label>Zona Horaria</label>
                            <select id="timezone">
                                <option value="America/Argentina/Buenos_Aires">Argentina (GMT-3)</option>
                                <option value="America/Santiago">Chile (GMT-4/-3)</option>
                                <option value="America/Bogota">Colombia (GMT-5)</option>
                                <option value="America/Mexico_City">México (GMT-6)</option>
                                <option value="America/Lima">Perú (GMT-5)</option>
                                <option value="America/Caracas">Venezuela (GMT-4)</option>
                                <option value="Europe/Madrid">España (GMT+1/+2)</option>
                                <option value="America/New_York">USA Este (GMT-5/-4)</option>
                                <option value="America/Los_Angeles">USA Oeste (GMT-8/-7)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Servidor NTP</label>
                            <input type="text" id="ntp-server" value="pool.ntp.org">
                        </div>
                    </div>

                    <!-- RF por defecto -->
                    <div class="config-section">
                        <h3>Configuración RF</h3>
                        <div class="form-group">
                            <label>Frecuencia por defecto</label>
                            <select id="default-frequency">
                                <option value="433.92">433.92 MHz</option>
                                <option value="315.00">315.00 MHz</option>
                                <option value="868.00">868.00 MHz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-detect-enabled" checked> Detección automática habilitada
                            </label>
                        </div>
                    </div>

                    <!-- Sistema -->
                    <div class="config-section">
                        <h3>Sistema</h3>
                        <div class="form-group">
                            <label>Nombre del dispositivo</label>
                            <input type="text" id="device-name" value="RF_Controller">
                        </div>
                        <div class="system-info">
                            <p><strong>IP:</strong> <span id="system-ip">--</span></p>
                            <p><strong>Uptime:</strong> <span id="system-uptime">--</span></p>
                            <p><strong>Memoria libre:</strong> <span id="system-heap">--</span></p>
                        </div>
                    </div>

                    <div class="config-actions">
                        <button class="btn btn-primary btn-large" onclick="saveConfig()">Guardar Configuración</button>
                        <button class="btn btn-secondary" onclick="loadConfig()">Recargar</button>
                    </div>
                </div>
            </section>

            <!-- Backup Tab -->
            <section id="backup-tab" class="tab-content">
                <div class="backup-section">
                    <h3>Respaldo de Configuración</h3>
                    <p>Exporta toda tu configuración y dispositivos guardados.</p>
                    <button class="btn btn-primary btn-large" onclick="downloadBackup()">
                        Descargar Backup
                    </button>
                </div>

                <div class="backup-section">
                    <h3>Restaurar Backup</h3>
                    <p>Restaura configuración desde un archivo de backup.</p>
                    <div class="file-upload">
                        <input type="file" id="backup-file" accept=".json">
                        <label for="backup-file" class="btn btn-secondary">Seleccionar archivo</label>
                    </div>
                    <button class="btn btn-warning btn-large" onclick="restoreBackup()">
                        Restaurar Backup
                    </button>
                </div>

                <div class="backup-section">
                    <h3>Actualizar Firmware</h3>
                    <p>Actualiza el firmware o el sistema de archivos del dispositivo.</p>
                    <div class="update-options">
                        <a href="/update" target="_blank" class="btn btn-primary btn-large">
                            Abrir Actualizador OTA
                        </a>
                    </div>
                    <small class="help-text">Se abrirá ElegantOTA en una nueva pestaña. Puedes subir firmware (.bin) o filesystem.</small>
                </div>

                <div class="backup-section danger-zone">
                    <h3>Zona de Peligro</h3>
                    <button class="btn btn-danger" onclick="confirmReboot()">Reiniciar Dispositivo</button>
                    <button class="btn btn-danger" onclick="confirmFactoryReset()">Restaurar de Fábrica</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal: Agregar Dispositivo -->
    <div id="modal-add-device" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Dispositivo</h2>
                <button class="modal-close" onclick="closeModal('modal-add-device')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="new-device-name" placeholder="Ej: Cortina Living">
                </div>
                <div class="form-group">
                    <label>Tipo de dispositivo</label>
                    <select id="new-device-type" onchange="showDeviceTypeInfo(this.value)">
                        <option value="1">Cortina (Abrir / Cerrar / Parar)</option>
                        <option value="10">Cortina Somfy RTS (Rolling Code)</option>
                        <option value="11">Cortina Dooya Bidir (FSK)</option>
                        <option value="12">Cortina A-OK AC114</option>
                        <option value="2">Interruptor (On / Off)</option>
                        <option value="3">Botón (Pulsar)</option>
                        <option value="4">Portón (Toggle o Abrir/Cerrar)</option>
                        <option value="5">Luz (On / Off)</option>
                        <option value="6">Ventilador (On / Off / Velocidad)</option>
                        <option value="7">Dimmer (On / Off / + / -)</option>
                        <option value="99">Otro (Personalizado)</option>
                    </select>
                    <small id="device-type-info" class="help-text">3 señales: Abrir, Cerrar, Parar</small>
                </div>
                <!-- Somfy RTS Config -->
                <div id="somfy-config" class="protocol-config" style="display:none;">
                    <div class="form-group">
                        <label>Dirección Somfy (hex)</label>
                        <div class="input-with-button">
                            <input type="text" id="new-somfy-address" placeholder="Ej: A1B2C3">
                            <button type="button" class="btn btn-small btn-secondary" onclick="generateRandomSomfyAddress()">Generar</button>
                        </div>
                        <small class="help-text">Dirección de 3 bytes. Genera una nueva para crear un control virtual.</small>
                    </div>
                    <div class="form-group">
                        <label>Rolling Code inicial</label>
                        <input type="number" id="new-somfy-rolling" value="1" min="0" max="65535">
                        <small class="help-text">Código inicial (se incrementa automáticamente)</small>
                    </div>
                </div>
                <!-- Dooya Bidir Config -->
                <div id="dooya-config" class="protocol-config" style="display:none;">
                    <div class="form-group">
                        <label>Device ID (hex)</label>
                        <div class="input-with-button">
                            <input type="text" id="new-dooya-device-id" placeholder="Ej: 12345678">
                            <button type="button" class="btn btn-small btn-secondary" onclick="generateRandomDooyaId()">Generar</button>
                        </div>
                        <small class="help-text">ID de 4 bytes. Genera uno nuevo para crear un control virtual.</small>
                    </div>
                    <div class="form-group">
                        <label>Unit Code</label>
                        <input type="number" id="new-dooya-unit" value="1" min="0" max="15">
                        <small class="help-text">Canal del motor (0-15)</small>
                    </div>
                </div>
                <!-- A-OK AC114 Config -->
                <div id="aok-config" class="protocol-config" style="display:none;">
                    <div class="form-group">
                        <label>Remote ID (hex)</label>
                        <div class="input-with-button">
                            <input type="text" id="new-aok-remote-id" placeholder="Ej: A1B2C3">
                            <button type="button" class="btn btn-small btn-secondary" onclick="generateRandomAokId()">Generar</button>
                        </div>
                        <small class="help-text">ID de 3 bytes. Copia el de tu control original o genera uno nuevo.</small>
                    </div>
                    <div class="form-group">
                        <label>Canal</label>
                        <input type="number" id="new-aok-channel" value="1" min="0" max="16">
                        <small class="help-text">Canal del motor (1-16) o 0 para control grupal (todas las cortinas)</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Habitación (opcional)</label>
                    <input type="text" id="new-device-room" placeholder="Ej: Living">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-add-device')">Cancelar</button>
                <button class="btn btn-primary" onclick="addDevice()">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Dispositivo -->
    <div id="modal-edit-device" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Editar Dispositivo</h2>
                <button class="modal-close" onclick="closeModal('modal-edit-device')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-device-id">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="edit-device-name">
                </div>
                <div class="form-group">
                    <label>Tipo de dispositivo</label>
                    <select id="edit-device-type">
                        <option value="1">Cortina (Abrir / Cerrar / Parar)</option>
                        <option value="10">Cortina Somfy RTS (Rolling Code)</option>
                        <option value="11">Cortina Dooya Bidir (FSK)</option>
                        <option value="2">Interruptor (On / Off)</option>
                        <option value="3">Botón (Pulsar)</option>
                        <option value="4">Portón (Toggle o Abrir/Cerrar)</option>
                        <option value="5">Luz (On / Off)</option>
                        <option value="6">Ventilador (On / Off / Velocidad)</option>
                        <option value="7">Dimmer (On / Off / + / -)</option>
                        <option value="99">Otro (Personalizado)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Habitación</label>
                    <input type="text" id="edit-device-room">
                </div>

                <h3>Señales Guardadas</h3>
                <div id="device-signals" class="signals-list">
                    <!-- Señales se cargan dinámicamente -->
                </div>

                <div class="add-signal-section">
                    <h4>Agregar Nueva Señal</h4>
                    <p>Ve a la pestaña "Capturar" para grabar una nueva señal, luego vuelve aquí para guardarla.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteDevice()">Eliminar Dispositivo</button>
                <button class="btn btn-secondary" onclick="closeModal('modal-edit-device')">Cancelar</button>
                <button class="btn btn-primary" onclick="updateDevice()">Guardar Cambios</button>
            </div>
        </div>
    </div>


    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <script src="app.js"></script>
</body>
</html>
